# В этом документе описываются бизнес-правила (Business Rules) проекта "К столу!"

## BR-R. Рецепты (BR-Recipes)

## BR-R1. Содержание рецепта (BR-Recipes.Content)

- **BR-R1.1. (BR-Recipes.Content.1)** Рецепт должен содержать название.
- **BR-R1.2. (BR-Recipes.Content.2)** Рецепт должен содержать хотя бы один ингредиент.
- **BR-R1.3. (BR-Recipes.Content.3)** Каждый ингредиент содержит: название, количество, единицу измерения и при необходимости уточнение (тип, вид, бренд и т.п.).
- **BR-R1.4. (BR-Recipes.Content.4)** Рецепт может содержать шаги приготовления.
- **BR-R1.5. (BR-Recipes.Content.5)** Рецепт может содержать общее и активное время приготовления.
- **BR-R1.6. (BR-Recipes.Content.6)** Рецепт может содержать обложку.
- **BR-R1.7. (BR-Recipes.Content.7)** Название рецепта должно быть уникальным в библиотеке Организатора.
- **BR-R1.8. (BR-Recipes.Content.8)** Рецепт может иметь указание на количество порций, 
на которое рассчитаны приведённые ингредиенты. Если параметр не указан, количество порций по умолчанию считается равным 1.
- **BR-R1.9. (BR-Recipes.Content.9)** Рецепт может иметь тип (категорию) из фиксированного списка,
  например: «салат», «горячее», «гарнир», «закуска», «десерт», «напиток».
  Тип рецепта используется для группировки и фильтрации рецептов в библиотеке.
  При отсутствии выбранного типа по умолчанию используется значение «другое».



## BR-R2. Ограничения на удаление рецепта (BR-Recipes.Delete)

- **BR-R2.1.  (BR-Recipes.Delete.1)** Рецепт не может быть удалён, если он используется в мероприятиях.
- **BR-R2.2.  (BR-Recipes.Delete.2)** В MVP удалённый рецепт не подлежит восстановлению (корзина отсутствует).


## BR-E. Мероприятия (BR-Events)

## BR-E1. Содержание мероприятия (BR-Events.Content)

- **BR-E1.1. (BR-Events.Content.1)** Мероприятие должно содержать название.
- **BR-E1.2. (BR-Events.Content.2)** Мероприятие должно содержать дату проведения. 
- **BR-E1.3. (BR-Events.Content.3)** Мероприятие может содержать рецепты
- **BR-E1.4. (BR-Events.Content.4)** Мероприятие может содержать список продуктов, который формируется и обновляется автоматически согласно правилам BR-ShoppingList.List.
- **BR-E1.5. (BR-Events.Content.5)** Мероприятие должно иметь уникальное сочетание названия и даты.
- **BR-E1.6. (BR-Events.Content.6)** Дата проведения мероприятия должна быть действительной календарной датой.

## BR-E2. Архивирование мероприятий (BR-Events.Archive)
- **BR-E2.1. (BR-Events.Archive.1)** Архивное мероприятие не отображается в основном списке мероприятий.
- **BR-E2.2. (BR-Events.Archive.2)** Архивное мероприятие не может быть отредактировано (в MVP).
- **BR-E2.3. (BR-Events.Archive.3)** Архивное мероприятие может быть открыто только для просмотра (см. UC-E6).
- **BR-E2.4. (BR-Events.Archive.4)** Архивное мероприятие может быть использовано для повторения (UC-E7).

## BR-E3. Удаление мероприятия (BR-Events.Delete)
- **BR-E3.1. (BR-Events.Delete.1)** Удалённое мероприятие не подлежит восстановлению (в MVP).
- **BR-E3.2. (BR-Events.Delete.2)** Мероприятие может быть удалено как из основного списка, так и из архива.

## BR-E4. Повторение мероприятия (BR-Events.Repeat)
- **BR-E4.1. (BR-Events.Repeat.1)** Повтор мероприятия создаёт новую сущность и не изменяет исходную.
- **BR-E4.2. (BR-Events.Repeat.2)** Все рецепты копируются в неизменном виде.
- **BR-E4.3. (BR-Events.Repeat.3)** Количество порций каждого рецепта наследуется от оригинала.
- **BR-E4.4. (BR-Events.Repeat.4)** Новый список покупок формируется заново согласно BR-ShoppingList.List.


# BR-L. Список покупок (BR-ShoppingList)

## BR-L1. Формирование и обновление списка покупок мероприятия (BR-ShoppingList.List)

- **BR-L1.1. (BR-ShoppingList.List.1)** Базовый список покупок мероприятия формируется на основе ингредиентов всех рецептов, добавленных в мероприятие.
- **BR-L1.2. (BR-ShoppingList.List.2)** При добавлении рецепта в мероприятие его ингредиенты добавляются в список покупок (с учётом объединения одинаковых ингредиентов).
- **BR-L1.3. (BR-ShoppingList.List.3)** При удалении рецепта из мероприятия из списка покупок удаляются только продукты, относящиеся к этому рецепту (количество уменьшается на вклад этого рецепта; если ингредиент больше нигде не используется, он удаляется из списка).
- **BR-L1.4. (BR-ShoppingList.List.4)** Ручные изменения Организатора в списке покупок (удаление/добавление позиций, редактирование количества, замена продукта) должны сохраняться и не должны автоматически перезаписываться при последующих изменениях состава рецептов.
- **BR-L1.5. (BR-ShoppingList.List.5)** Список покупок не пересчитывается полностью при каждом изменении состава рецептов; используются только инкрементальные изменения согласно BR-L1.2 и BR-L1.3.
- **BR-L1.6. (BR-ShoppingList.List.6)** Организатор может вручную инициировать полное пересоздание списка покупок. При полном пересоздании система удаляет все текущие позиции списка покупок и формирует его заново на основе актуального набора рецептов и их порций.
- **BR-L1.7. (BR-ShoppingList.List.7)** Для каждой позиции в списке покупок должна сохраняться информация о её происхождении: из каких рецептов и ингредиентов она сформирована. Эта информация должна быть доступна пользователю по запросу.
- **BR-L1.8. (BR-ShoppingList.List.8)** Организатор и Участники по ссылке могут отмечать товары в списке покупок как купленные или не купленные.
- **BR-L1.9. (BR-ShoppingList.List.9)** В MVP добавлять и удалять позиции списка покупок, а также пересоздавать список целиком может только Организатор.
- **BR-L1.10. (BR-ShoppingList.List.10)** У пункта списка продуктов может быть два статуса: "куплен" и "некуплен". Они должны явно показывать пользователю своё значение.
### Дополнительные правила (расширение логики, номера не пересекаются с существующими)
- **BR-L1.11. (BR-ShoppingList.List.11)** Позиции списка покупок делятся на два типа:
  - автоматические — сформированные системой на основе рецептов,
  - ручные — добавленные Организатором вручную.
- **BR-L1.12. (BR-ShoppingList.List.12)** Автоматические позиции списка покупок не могут быть изменены или удалены вручную, чтобы сохранить корректность агрегации ингредиентов, обновления списка покупок и пересоздания списка.
- **BR-L1.13. (BR-ShoppingList.List.13)** Ручные позиции списка покупок могут быть удалены и изменены Организатором.
- **BR-L1.14. (BR-ShoppingList.List.14)** Если ингредиент уже есть дома, он не удаляется из списка покупок. Рекомендуемый способ исключения такого ингредиента — отметить его как «куплен», сохранив структуру списка и связи между ингредиентами и рецептами.
- **BR-L1.15. (BR-ShoppingList.List.15)** При одновременном изменении одного и того же пункта списка покупок несколькими пользователями последнее успешно обработанное изменение считается актуальным ("правило последнего изменения").


## BR-L2. Масштабирование порций рецептов в мероприятии (BR-ShoppingList.Scaling)
- **BR-L2.1. (BR-ShoppingList.Scaling.1)** Каждому рецепту, добавленному в мероприятие, может быть задано желаемое количество порций.
- **BR-L2.2. (BR-ShoppingList.Scaling.2)** Если рецепт имеет базовое количество порций (см. BR-R1.7), система вычисляет коэффициент масштабирования:
               коэффициент = желаемые порции / базовые порции.
- **BR-L2.3. (BR-ShoppingList.Scaling.3)** Все ингредиенты рецепта масштабируются на этот коэффициент.
- **BR-L2.4. (BR-ShoppingList.Scaling.4)** Изменение количества порций вызывает инкрементальное обновление списка покупок (см. BR-L1.2, L1.3).


## BR-L3. Содержание ингредиента (BR-ShoppingList.IngredientContent)

- **BR-L3.1 (BR-ShoppingList.IngredientContent.1)** Ингредиент должен содержать название.
- **BR-L3.2 (BR-ShoppingList.IngredientContent.2)** Ингредиент должен содержать количество.
- **BR-L3.3 (BR-ShoppingList.IngredientContent.3)** Ингредиент должен содержать единицы измерения.
- **BR-L3.4 (BR-ShoppingList.IngredientContent.4)** Ингредиент может содержать заметку.


# BR-C. Коллаборация (BR-Collaboraton)

## BR-C0. Роли пользователей

- **BR-C0.1.** *Организатор* — пользователь, идентифицируемый системой по уникальному user_id
  (локально сохранённому в браузере), являющийся владельцем рецептов и мероприятий.
- **BR-C0.2.** *Участник по ссылке* — пользователь, перешедший по ссылке приглашения и не являющийся владельцем мероприятия.
- **BR-C0.3.** В MVP отсутствует регистрация, логин и пароль; идентификация Организатора выполняется по локальному идентификатору пользователя.

## BR-C1. Доступ к мероприятию по ссылке

- BR-C1.1. Для каждого мероприятия система автоматически создаёт одну ссылку-приглашение вида: `https://k-stolu.app/event/<token>` при создании мероприятия.
- BR-C1.2. Эта ссылка постоянна на весь срок существования мероприятия.
- BR-C1.3. Повторное создание ссылки не выполняется — используется существующая.

## BR-C2. Права Организатора

Организатор имеет полный доступ к мероприятиям, владельцем которых он является (`owner_id = user_id`).

Организатор может:
- **BR-C2.1.** Создавать, редактировать и удалять рецепты.
- **BR-C2.2.** Создавать, редактировать, архивировать и удалять мероприятия.
- **BR-C2.3.** Добавлять и удалять рецепты из мероприятия.
- **BR-C2.4.** Изменять количество порций рецептов в мероприятии.
- **BR-C2.5.** Пересоздавать список покупок.
- **BR-C2.6.** Создавать ссылку на мероприятие и делиться ею.
- **BR-C2.7.** Просматривать как активные, так и архивные мероприятия.

## BR-C3. Права Участника по ссылке

Участник по ссылке может:
- **BR-C3.1.** Просматривать содержание мероприятия (название, дата, список рецептов).
- **BR-C3.2.** Просматривать рецепты мероприятия.
- **BR-C3.3.** Просматривать список покупок.
- **BR-C3.4.** Менять статусы пунктов списка покупок: «куплено/не куплено» (см. BR-L1.8–BR-L1.10).

Участник по ссылке не может:
- **BR-C3.5.** Редактировать мероприятие (название, дату).
- **BR-C3.6.** Добавлять или удалять рецепты.
- **BR-C3.7.** Пересоздавать список покупок.
- **BR-C3.8.** Архивировать или удалять мероприятие.
- **BR-C3.9.** Создавать, редактировать или удалять рецепты.

## BR-C4. Поведение системы при определении роли

- **BR-C4.1.** При открытии мероприятия система сравнивает `user_id` (если он существует) с `owner_id` мероприятия:
  - если совпадают → пользователь считается Организатором;
  - если не совпадают или `user_id` отсутствует → пользователь считается Участником.
- **BR-C4.2.** Интерфейс и API скрывают или запрещают недоступные действия в зависимости от роли.
- **BR-C4.3.** Если мероприятие было удалено Организатором, все ссылки (`event_token`) на него становятся недействительными.

## BR-C5. Конкуренция изменения общих данных

- **BR-C5.1.** Одновременно менять статусы пунктов списка покупок (куплено/не куплено)
могут несколько пользователей (Организатор и Участники по ссылке).
- **BR-C5.2.** При одновременном изменении одного и того же пункта списка покупок 
последнее успешно обработанное изменение считается актуальным (правило 
«последний выиграл»).
- **BR-C5.3.** В рамках MVP система не обнаруживает и не визуализирует конфликты 
редактирования статусов; пользователи видят актуальное состояние после 
обновления данных (автообновление или обновление страницы).



# BR-S. Общие правила обработки ошибок

- **BR-S1.** Любая операция изменения данных (создание, редактирование, удаление) выполняется атомарно: либо все изменения применяются, либо при ошибке система откатывает их.
- **BR-S2.** При возникновении технической ошибки (ошибка сервера, сети, БД) система:
  - сообщает пользователю об ошибке понятным текстом,
  - не применяет частичных изменений,
  - оставляет пользователя на текущем экране с возможностью повторить действие.
- **BR-S3.** При ошибке валидации (некорректные или конфликтующие данные) система:
  - показывает сообщение с указанием проблемы (например, конфликт уникального названия и даты),
  - подсвечивает поля с ошибками,
  - даёт пользователю возможность исправить данные без потери уже введённой формы.




